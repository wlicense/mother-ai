# 🛡️ 安全なテスト手順（課金リスク0）

**作成日**: 2025-11-09
**目的**: Claude API課金を最小限に抑えながらテスト

---

## 1. モックモードで全機能テスト（コスト: 0円）

### 起動方法

```bash
# バックエンド起動（モックモード）
cd backend
source venv/bin/activate

# USE_REAL_AIを明示的にfalseに設定
export USE_REAL_AI=false
python -m app.main
```

```bash
# フロントエンド起動
cd frontend
npm run dev
```

### テスト内容

**ブラウザで http://localhost:3348 にアクセス:**

1. ✅ アカウント作成
2. ✅ ログイン
3. ✅ プロジェクト作成
4. ✅ Phase 1-14を順番に実行
5. ✅ 生成されたコードを確認
6. ✅ デプロイ手順を確認

**モックモードの動作:**
- Phase 1-14: テンプレートベースのレスポンス
- コスト: **完全に0円**
- Claude API: **一切呼ばれない**

---

## 2. Claude API使用量上限設定（コスト: 0円）

**実APIを使う前に必ず設定！**

### Anthropic Consoleで上限設定

1. https://console.anthropic.com にアクセス
2. 左メニュー「Settings」→「Billing」
3. 「Usage limits」をクリック
4. **Monthly spend limit**を設定:
   - 推奨: **$5（約¥500）**
   - 最小: **$1（約¥100）**

### アラート設定

1. 同じページで「Email alerts」を有効化
2. アラート閾値:
   - 50%使用時: メール通知
   - 80%使用時: メール通知
   - 100%到達: API自動停止

**これで課金が暴走する心配なし！**

---

## 3. 最小限の実APIテスト（コスト: ¥50以下）

**上限設定後のみ実施**

### テスト方法

```bash
# バックエンド
cd backend
source venv/bin/activate

# 実APIモードで起動（上限設定後のみ！）
export USE_REAL_AI=true
export MAX_TOKENS=500  # トークン数を制限
python -m app.main
```

### 最小テスト（1回だけ）

**Phase 1を1回だけ実行:**
1. プロジェクト作成
2. Phase 1で簡単な質問（「ToDoアプリを作りたい」）
3. 1往復だけ会話
4. **すぐに終了**

**推定コスト**: ¥30-50
**トークン**: 約5,000-10,000トークン

### 使用量確認

```bash
# APIダッシュボードで確認
https://console.anthropic.com/settings/usage
```

---

## 4. コスト監視の仕組み

### リアルタイム監視

マザーAIの管理画面：
- http://localhost:3348/admin/api-monitor
- リアルタイムAPI使用量グラフ
- コスト推定表示

### ログ確認

```bash
# API使用履歴を確認
curl http://localhost:8572/api/v1/admin/api-usage
```

---

## 5. 緊急停止方法

### APIキーを無効化

**課金が心配な場合、即座に停止:**

```bash
# .envファイルを編集
cd backend
nano .env

# CLAUDE_API_KEYをコメントアウト
# CLAUDE_API_KEY=sk-ant-xxxxx

# サーバー再起動
# 自動的にモックモードに切り替わる
```

または：

```bash
# 環境変数を空にして再起動
export CLAUDE_API_KEY=""
python -m app.main
```

---

## 6. 段階的な進め方（推奨）

### フェーズ1: モックモードで完全理解（0円）
- 全Phase 1-14を試す
- UIの動作を理解
- ワークフローを把握
- **期間**: 1-2日

### フェーズ2: 上限設定（0円）
- Anthropic Consoleで$5上限設定
- アラート有効化
- **期間**: 5分

### フェーズ3: 最小テスト（¥50）
- Phase 1を1回だけ
- 使用量を確認
- **期間**: 10分

### フェーズ4: 段階的拡大（¥100-500）
- Phase 2を1回
- Phase 3を1回
- 毎回使用量を確認
- **期間**: 1週間

---

## 7. コスト削減のコツ

### プロンプトキャッシング活用

```python
# 既に実装済み（50%削減）
use_cache=True  # デフォルトで有効
```

### トークン制限

```python
# claude_client.pyで設定
max_tokens=2000  # デフォルト4096から削減
```

### モデル選択

```python
# Haiku使用でコスト1/5
CLAUDE_MODEL=claude-3-haiku-20250307
```

---

## 8. 安全チェックリスト

実APIテスト前に確認:

- [ ] モックモードで全機能テスト済み
- [ ] Anthropic Consoleで月間上限設定済み（$5推奨）
- [ ] メールアラート有効化済み
- [ ] 最初は1回だけテスト
- [ ] 使用量ダッシュボードを開いている
- [ ] 緊急停止方法を理解している

**全てチェックOKなら実APIテスト可能！**

---

## まとめ

| 段階 | 内容 | コスト | 安全性 |
|-----|------|-------|-------|
| 1. モックモード | 全機能テスト | **¥0** | ✅✅✅ 完全安全 |
| 2. 上限設定 | API上限$5設定 | **¥0** | ✅✅✅ 必須 |
| 3. 最小テスト | Phase 1×1回 | **¥50** | ✅✅ 上限設定後 |
| 4. 段階拡大 | Phase 2-3 | **¥500** | ✅ 監視しながら |

**推奨**: まずは1-2をやって、3は様子を見てから！
